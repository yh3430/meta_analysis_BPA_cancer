---
title: "BPA_cancer"
author: "Yu He"
date: "2024-03-03"
output: 
  html_document:
    fig_width: 12
    fig_height: 10
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(meta)
library(readxl)
library(metafor)
```

# Data Import
```{r}
setwd("~/Desktop/meta analysis/BPA_cancer")

# load the data with strongest effect of OR
meta_data_s <- read_excel("data.xlsx", sheet = "strong_or") %>% 
  janitor::clean_names()

# load the data with average effect of OR
meta_data_a <- read_excel("data.xlsx", sheet = "average_or") %>% 
  janitor::clean_names()
```


# Conduct meta analysis
```{r}
# Calculate the log of odds ratios and their standard errors
# strong effect of OR
meta_data_s <- meta_data_s %>% 
  mutate(
    log_odds_ratio = log(or),
    lower_log =log(lower_ci),
    upper_log = log(upper_ci),
    se_log_odds_ratio = (upper_log - lower_log) / (2 * 1.96) # 1.96 is the Z value for 95% CI
  )

# average OR
meta_data_a <- meta_data_a %>% 
  mutate(
    log_odds_ratio = log(or),
    lower_log =log(lower_ci),
    upper_log = log(upper_ci),
    se_log_odds_ratio = (upper_log - lower_log) / (2 * 1.96) # 1.96 is the Z value for 95% CI
  )

# Perform meta-analysis
# strong effect of OR
meta_s_analysis <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = meta_data_s,
  sm = "OR"
)

# average OR
meta_a_analysis <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = meta_data_a,
  sm = "OR"
)


# Summary of the meta-analysis
# strong effect of OR
summary(meta_s_analysis)
# average OR
summary(meta_a_analysis)


# Forest plot
# strong effect of OR
# pdf(file = "forestplot_strongeffect.pdf", width = 12, height = 10), use to save the forest plot
forest(meta_s_analysis, 
       sortvar = TE,
       prediction = TRUE,
       leftlabs = c("Author", "g", "SE")
       )

# average OR
# pdf(file = "forestplot_average.pdf", width = 12, height = 10)
forest(meta_a_analysis, 
       sortvar = TE,
       prediction = TRUE,
       leftlabs = c("Author", "g", "SE")
       )

# dev.off(), use to save the forest plot
```


# Assess the publication bias
```{r}
# Funnel plot
# strong effect of OR
funnel(meta_s_analysis)
# average OR
funnel(meta_a_analysis)

# assess the asymmetry of funnel plot and publication bias
# Conduct the meta-analysis using rma() function from metafor
# strong effect of OR
meta_s_analysis_rma <- rma(yi = log_odds_ratio, sei = se_log_odds_ratio, method = "REML", data = meta_data_s)

# Perform Egger's test for publication bias
eggers_test_s <- regtest(meta_s_analysis_rma, model = "lm")

# Output the results of Egger's test
summary(eggers_test_s$fit)

# average OR
meta_a_analysis_rma <- rma(yi = log_odds_ratio, sei = se_log_odds_ratio, method = "REML", data = meta_data_a)

# Perform Egger's test for publication bias
eggers_test_a <- regtest(meta_a_analysis_rma, model = "lm")

# Output the results of Egger's test
summary(eggers_test_a$fit)
```


```{r}
# Begg's Test
# strong effect of OR
begg_test_s <- ranktest(meta_s_analysis_rma)
print(begg_test_s)

# average OR
begg_test_a <- ranktest(meta_a_analysis_rma)
print(begg_test_a)
```


```{r}
# Trim and Fill Method
# strong effect of OR
trimfill_result_s <- trimfill(meta_s_analysis_rma, estimator = "R0")
print(trimfill_result_s)

# average OR
trimfill_result_a <- trimfill(meta_a_analysis_rma, estimator = "R0")
print(trimfill_result_a)
```



# Sensitivity analysis between different study types,  without cross sectional study design vs with cross sectional study design
```{r}
# re-code the data
# strong effect of OR
meta_data_s_sen <- meta_data_s %>% 
  mutate(
    study_design = factor(study_design, levels = c(0, 1), labels = c("case-control", "cross-sectional"))
  )

# average OR
meta_data_a_sen <- meta_data_a %>% 
  mutate(
    study_design = factor(study_design, levels = c(0, 1), labels = c("case-control", "cross-sectional"))
  )
```


```{r}
# strong effect of OR without cross sectional study design
meta_s_analysis_cc <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_s_sen, study_design == "case-control"),
  sm = "OR"
)

# average OR without cross sectional study design
meta_a_analysis_cc <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_a_sen, study_design == "case-control"),
  sm = "OR"
)


# Summary of the meta-analysis
# strong effect of OR
summary(meta_s_analysis_cc)
summary(meta_s_analysis)

# average OR
summary(meta_a_analysis_cc)
summary(meta_a_analysis)
```



```{r}
# only cross sectional study
meta_s_analysis_cs <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_s_sen, study_design == "cross-sectional"),
  sm = "OR"
)

summary(meta_s_analysis_cs)
funnel(meta_s_analysis_cs)

meta_a_analysis_cs <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_a_sen, study_design == "cross-sectional"),
  sm = "OR"
)

summary(meta_a_analysis_cs)
funnel(meta_a_analysis_cs)
```


```{r}
# Funnel plot 
# strong effect of OR
funnel(meta_s_analysis_cc)
# average OR
funnel(meta_a_analysis_cc)
```

# remove 'Keshavarz4_urine', 'Keshavarz4_tissue', 'Hong8', 'Marotta23' study due to large 95% CI
```{r}
# strong effect OR
meta_data_s_remove <- meta_data_s %>% 
  filter(!(auther %in% c('Keshavarz4_urine', 'Keshavarz4_tissue', 'Hong8', 'Marotta23')))


meta_s_analysis_remove <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = meta_data_s_remove,
  sm = "OR"
)

summary(meta_s_analysis_remove)
summary(meta_s_analysis)


# average OR
meta_data_a_remove <- meta_data_a %>% 
  filter(!(auther %in% c('Keshavarz4_urine', 'Keshavarz4_tissue', 'Hong8', 'Marotta23')))


meta_a_analysis_remove <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = meta_data_a_remove,
  sm = "OR"
)

summary(meta_a_analysis_remove)
summary(meta_a_analysis)
```


```{r}
# subgroup - nation after remove some papers
# strong effect OR
meta_data_s_na <- meta_data_s_remove %>% 
  mutate(
    region_code = ifelse(region == "China", 0, 1)
  )

meta_s_analysis_china <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_s_na, region_code == "0"), # China
  sm = "OR"
)

meta_s_analysis_other <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_s_na, region_code == "1"), # other region
  sm = "OR"
)

summary(meta_s_analysis_china)
summary(meta_s_analysis_other)
summary(meta_s_analysis)

# average OR
meta_data_a_na <- meta_data_a_remove %>% 
  mutate(
    region_code = ifelse(region == "China", 0, 1)
  )

meta_a_analysis_china <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_a_na, region_code == "0"), # China
  sm = "OR"
)

meta_a_analysis_other <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_a_na, region_code == "1"), # other region
  sm = "OR"
)

summary(meta_a_analysis_remove)
summary(meta_a_analysis)
```




# subgroup meta_analysis. In the above sensitivity analysis we kind of do the subgroup of study designs. The results show high heterogenetity. 
```{r}
# subgroup - nation
# strong effect OR
meta_data_s_na <- meta_data_s %>% 
  mutate(
    region_code = ifelse(region == "China", 0, 1)
  )

meta_s_analysis_china <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_s_na, region_code == "0"), # China
  sm = "OR"
)


meta_s_analysis_other <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_s_na, region_code == "1"), # other region
  sm = "OR"
)

# average OR
meta_data_a_na <- meta_data_a %>% 
  mutate(
    region_code = ifelse(region == "China", 0, 1)
  )

meta_a_analysis_china <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_a_na, region_code == "0"), # China
  sm = "OR"
)

meta_a_analysis_other <- metagen(
  TE = log_odds_ratio,
  seTE = se_log_odds_ratio,
  studlab = paste(auther),
  data = subset(meta_data_a_na, region_code == "1"), # other region
  sm = "OR"
)
```











